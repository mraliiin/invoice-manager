var express=require("express"),bodyParser=require("body-parser"),http=require("http"),path=require("path"),cors=require("cors"),Sequelize=require("sequelize"),_=require("lodash");sequelize=new Sequelize("sqlite://"+path.join(__dirname,"invoices.sqlite"),{dialect:"sqlite",storage:path.join(__dirname,"invoices.sqlite")}),Customer=sequelize.define("customers",{id:{type:Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},name:{type:Sequelize.STRING},address:{type:Sequelize.STRING},phone:{type:Sequelize.STRING}}),Product=sequelize.define("products",{id:{type:Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},name:{type:Sequelize.STRING},price:{type:Sequelize.DECIMAL}}),Invoice=sequelize.define("invoices",{id:{type:Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},customer_id:{type:Sequelize.INTEGER},discount:{type:Sequelize.DECIMAL},total:{type:Sequelize.DECIMAL}}),InvoiceItem=sequelize.define("invoice_items",{id:{type:Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},invoice_id:{type:Sequelize.INTEGER},product_id:{type:Sequelize.INTEGER},quantity:{type:Sequelize.DECIMAL}}),sequelize.sync().then(function(){Customer.create({name:"Mark Benson",address:"353 Rochester St, Rialto FL 43250",phone:"555-534-2342"}),Customer.create({name:"Bob Smith",address:"215 Market St, Dansville CA 94325",phone:"555-534-2342"}),Customer.create({name:"John Draper",address:"890 Main St, Fontana IL 31450",phone:"555-534-2342"}),Product.create({name:"Parachute Pants",price:29.99}),Product.create({name:"Phone Holder",price:9.99}),Product.create({name:"Pet Rock",price:5.99}),Product.create({name:"Egg Timer",price:15.99}),Product.create({name:"Neon Green Hat",price:21.99})}).catch(function(e){console.log("ERROR SYNCING WITH DB",e)});var app=module.exports=express();app.set("port",process.env.PORT||8e3),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!0})),app.use(express.static(path.join(__dirname,"/"))),app.use(cors()),app.route("/api/customers").get(function(e,n){Customer.findAll().then(function(e){n.json(e)})}).post(function(e,n){Customer.build(_.pick(e.body,["name","address","phone"])).save().then(function(e){n.json(e)})}),app.route("/api/customers/:customer_id").get(function(e,n){Customer.findById(e.params.customer_id).then(function(e){n.json(e)})}).put(function(e,n){Customer.findById(e.params.customer_id).then(function(t){t.update(_.pick(e.body,["name","address","phone"])).then(function(e){n.json(e)})})}).delete(function(e,n){Customer.findById(e.params.customer_id).then(function(e){e.destroy().then(function(e){n.json(e)})})}),app.route("/api/products").get(function(e,n){Product.findAll().then(function(e){n.json(e)})}).post(function(e,n){Product.build(_.pick(e.body,["name","price"])).save().then(function(e){n.json(e)})}),app.route("/api/products/:product_id").get(function(e,n){Product.findById(e.params.product_id).then(function(e){n.json(e)})}).put(function(e,n){Product.findById(e.params.product_id).then(function(t){t.update(_.pick(e.body,["name","price"])).then(function(e){n.json(e)})})}).delete(function(e,n){Product.findById(e.params.product_id).then(function(e){e.destroy().then(function(e){n.json(e)})})}),app.route("/api/invoices").get(function(e,n){Invoice.findAll().then(function(e){n.json(e)})}).post(function(e,n){Invoice.build(_.pick(e.body,["customer_id","discount","total"])).save().then(function(e){n.json(e)})}),app.route("/api/invoices/:invoice_id").get(function(e,n){Invoice.findById(e.params.invoice_id).then(function(e){n.json(e)})}).put(function(e,n){Invoice.findById(e.params.invoice_id).then(function(t){t.update(_.pick(e.body,["customer_id","discount","total"])).then(function(e){n.json(e)})})}).delete(function(e,n){Invoice.findById(e.params.invoice_id).then(function(e){e.destroy().then(function(e){n.json(e)})})}),app.route("/api/invoices/:invoice_id/items").get(function(e,n){InvoiceItem.findAll({where:{invoice_id:e.params.invoice_id}}).then(function(e){n.json(e)})}).post(function(e,n){var t=InvoiceItem.build(_.pick(e.body,["product_id","quantity"]));t.set("invoice_id",e.params.invoice_id),t.save().then(function(e){n.json(e)})}),app.route("/api/invoices/:invoice_id/items/:id").get(function(e,n){InvoiceItem.findById(e.params.id).then(function(e){n.json(e)})}).put(function(e,n){InvoiceItem.findById(e.params.id).then(function(t){t.update(_.pick(e.body,["product_id","quantity"])).then(function(e){n.json(e)})})}).delete(function(e,n){InvoiceItem.findById(e.params.id).then(function(e){e.destroy().then(function(e){n.json(e)})})}),app.get("*",function(e,n){n.sendFile(path.join(__dirname,"index.html"))}),http.createServer(app).listen(app.get("port"),function(){console.log("Express server listening on port "+app.get("port"))});